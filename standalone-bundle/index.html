<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanilla AI</title>
    <meta name="description" content="Build free, standalone OpenAI SDK">
    <meta name="theme-color" content="#2563eb">

    <!-- Inline favicon (ice cream cone icon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m7 11 4.08 10.35a1 1 0 0 0 1.84 0L17 11'/%3E%3Cpath d='M17 7A5 5 0 0 0 7 7'/%3E%3Cpath d='M17 7a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m7 11 4.08 10.35a1 1 0 0 0 1.84 0L17 11'/%3E%3Cpath d='M17 7A5 5 0 0 0 7 7'/%3E%3Cpath d='M17 7a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4'/%3E%3C/svg%3E">

    <!-- Inline manifest for PWA support -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Vanilla%20AI%22%2C%22short_name%22%3A%22Vanilla%20AI%22%2C%22description%22%3A%22Build%20free%2C%20standalone%20OpenAI%20SDK%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%232563eb%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A//www.w3.org/2000/svg%27%2520viewBox%3D%270%25200%252024%252024%27%2520fill%3D%27none%27%2520stroke%3D%27%25232563eb%27%2520stroke-width%3D%272%27%2520stroke-linecap%3D%27round%27%2520stroke-linejoin%3D%27round%27%253E%253Cpath%2520d%3D%27m7%252011%25204.08%252010.35a1%25201%25200%25200%25200%25201.84%25200L17%252011%27/%253E%253Cpath%2520d%3D%27M17%25207A5%25205%25200%25200%25200%25207%25207%27/%253E%253Cpath%2520d%3D%27M17%25207a2%25202%25200%25200%25201%25200%25204H7a2%25202%25200%25200%25201%25200-4%27/%253E%253C/svg%253E%22%2C%22sizes%22%3A%22any%22%2C%22type%22%3A%22image/svg%2Bxml%22%7D%5D%7D">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Custom overlay scrollbars */
        .overlay-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        }
        
        .overlay-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .overlay-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .overlay-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        .overlay-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.8);
        }
        
        /* Dark mode scrollbar colors */
        .dark .overlay-scrollbar {
            scrollbar-color: rgba(115, 115, 115, 0.5) transparent;
        }
        
        .dark .overlay-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(115, 115, 115, 0.5);
        }
        
        .dark .overlay-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(115, 115, 115, 0.8);
        }
    </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 min-h-screen transition-colors">
    <!-- Header -->
    <header class="bg-white dark:bg-neutral-800 shadow-sm border-b border-neutral-200 dark:border-neutral-700 transition-colors">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg class="w-8 h-8 mr-3 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m7 11 4.08 10.35a1 1 0 0 0 1.84 0L17 11"/>
                        <path d="M17 7A5 5 0 0 0 7 7"/>
                        <path d="M17 7a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4"/>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold text-neutral-900 dark:text-white">Vanilla AI</h1>
                        <p class="text-neutral-600 dark:text-neutral-300 text-sm mt-1">Build free, standalone OpenAI SDK</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- API Key Setup -->
        <div id="setup" class="bg-white dark:bg-neutral-800 rounded-lg shadow-md p-6 mb-6 transition-colors">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white mb-4">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-11.83 1.82L9 15h3l-3 3-3-3h3l1.83-1.82A6 6 0 0117 9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"></path>
                </svg>
                Setup
            </h2>
            <form onsubmit="initializeApp(); return false;">
                <div class="space-y-4">
                    <!-- Hidden username field for accessibility -->
                    <input type="text" name="username" autocomplete="username" style="display: none;" readonly>
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                            OpenAI API Key
                        </label>
                        <input
                            type="password"
                            id="apiKey"
                            name="password"
                            placeholder="sk-... (optional for some endpoints)"
                            autocomplete="current-password"
                            class="w-full px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                        >
                    </div>
                    <div>
                        <label for="baseUrl" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                            Base URL (Optional)
                        </label>
                        <input
                            type="url"
                            id="baseUrl"
                            placeholder="https://api.openai.com/v1"
                            class="w-full px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                        >
                        <p class="mt-1 text-xs text-neutral-500 dark:text-neutral-400">Leave empty for default OpenAI API. Use for custom endpoints or proxies.</p>
                    </div>
                    <button
                        type="submit"
                        class="w-full bg-blue-600 dark:bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors font-medium"
                    >
                        Start App
                    </button>
                    <p class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">API key is optional for some endpoints. Leave empty if not required.</p>
                </div>
            </form>
        </div>

        <!-- Main App Interface -->
        <div id="appContainer" class="hidden">
            <!-- Tabs -->
            <div class="bg-white dark:bg-neutral-800 rounded-t-lg shadow-md transition-colors">
                <div class="flex border-b border-neutral-200 dark:border-neutral-700">
                    <button
                        onclick="switchTab('chat')"
                        id="chatTab"
                        class="flex-1 px-3 py-3 text-center font-medium text-lg bg-neutral-600 dark:bg-neutral-500 text-white rounded-tl-lg transition-colors"
                        title="Chat"
                    >
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </button>
                    <button
                        onclick="switchTab('image')"
                        id="imageTab"
                        class="flex-1 px-3 py-3 text-center font-medium text-lg text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 bg-neutral-50 dark:bg-neutral-700 transition-colors"
                        title="Image Generation"
                    >
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    <button
                        onclick="switchTab('tts')"
                        id="ttsTab"
                        class="flex-1 px-3 py-3 text-center font-medium text-lg text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 bg-neutral-50 dark:bg-neutral-700 transition-colors"
                        title="Text-to-Speech"
                    >
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 13a2 2 0 0 0 2-2V7a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0V4a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0v-4a2 2 0 0 1 2-2"/>
                        </svg>
                    </button>
                    <button
                        onclick="switchTab('settings')"
                        id="settingsTab"
                        class="flex-1 px-3 py-3 text-center font-medium text-lg text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 bg-neutral-50 dark:bg-neutral-700 rounded-tr-lg transition-colors"
                        title="Settings"
                    >
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 7h-9"/>
                            <path d="M14 17H5"/>
                            <circle cx="17" cy="17" r="3"/>
                            <circle cx="7" cy="7" r="3"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat Tab Content -->
            <div id="chatContent" class="bg-white dark:bg-neutral-800 rounded-b-lg shadow-md transition-colors h-[600px] flex flex-col">
                <!-- Chat Settings -->
                <div class="px-4 py-2 border-b border-neutral-200 dark:border-neutral-700 flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <!-- Unified Chat Model Dropdown -->
                            <div id="chatModelDropdown"></div>
                            
                            <!-- Hidden inputs for compatibility -->
                            <select id="chatModel" class="hidden">
                                <option value="">Loading models...</option>
                            </select>
                            <input type="text" id="customModel" class="hidden">
                        </div>
                        <button
                            onclick="clearChat()"
                            class="px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors"
                        >
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="flex-1 overflow-y-auto min-h-0 overlay-scrollbar" id="chatMessages">
                    <div class="p-4">
                        <div class="text-center text-neutral-500 dark:text-neutral-400 text-sm">
                            Start the conversation!
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="p-4 border-t border-neutral-200 dark:border-neutral-700 flex-shrink-0">
                    <div class="flex space-x-2">
                        <input
                            type="text"
                            id="messageInput"
                            placeholder="Type your message..."
                            class="flex-1 px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button
                            onclick="sendMessage()"
                            id="sendButton"
                            class="bg-neutral-600 dark:bg-neutral-500 text-white px-6 py-2 rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium disabled:bg-neutral-400"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Tab Content -->
            <div id="imageContent" class="hidden bg-white dark:bg-neutral-800 rounded-b-lg shadow-md transition-colors">
                <!-- Image Settings -->
                <div class="p-4 border-b border-neutral-200 dark:border-neutral-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Model
                            </label>
                            <div id="imageModelDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="imageModel" class="hidden"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Size
                            </label>
                            <div id="imageSizeDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="imageSize" class="hidden"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Quality
                            </label>
                            <div id="imageQualityDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="imageQuality" class="hidden"></select>
                        </div>
                        <div id="responseFormatContainer">
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Response Format
                            </label>
                            <div id="responseFormatDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="responseFormat" class="hidden"></select>
                        </div>
                    </div>
                </div>

                <!-- Image Generation -->
                <div class="p-4">
                    <div class="space-y-4">
                        <div>
                            <label for="imagePrompt" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                                Image Prompt
                            </label>
                            <textarea
                                id="imagePrompt"
                                rows="3"
                                placeholder="Describe the image you want to generate..."
                                class="w-full px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                            ></textarea>
                        </div>
                        <button
                            onclick="generateImage()"
                            id="generateButton"
                            class="w-full bg-neutral-600 dark:bg-neutral-500 text-white py-2 px-4 rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium disabled:bg-neutral-400"
                        >
                            Generate Image
                        </button>
                    </div>
                </div>

                <!-- Generated Images -->
                <div id="imageResults" class="p-4 border-t border-neutral-200 dark:border-neutral-700 max-h-96 overflow-y-auto overlay-scrollbar">
                    <div class="text-center text-neutral-500 dark:text-neutral-400 text-sm">
                        Generated images will appear here
                    </div>
                </div>
            </div>

            <!-- TTS Tab Content -->
            <div id="ttsContent" class="hidden bg-white dark:bg-neutral-800 rounded-b-lg shadow-md transition-colors">
                <!-- TTS Settings -->
                <div class="p-4 border-b border-neutral-200 dark:border-neutral-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Model
                            </label>
                            <div id="ttsModelDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="ttsModel" class="hidden"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Voice
                            </label>
                            <div id="ttsVoiceDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="ttsVoice" class="hidden"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                Speed
                            </label>
                            <div id="ttsSpeedDropdown"></div>
                            <!-- Hidden select for compatibility -->
                            <select id="ttsSpeed" class="hidden"></select>
                        </div>
                    </div>
                </div>

                <!-- TTS Input -->
                <div class="p-4">
                    <div class="space-y-4">
                        <div>
                            <label for="ttsText" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                                Text to Speech
                            </label>
                            <textarea
                                id="ttsText"
                                rows="4"
                                placeholder="Enter the text you want to convert to speech..."
                                class="w-full px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                                maxlength="4096"
                            ></textarea>
                            <div class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">
                                <span id="charCount">0</span>/4096 characters
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button
                                onclick="generateSpeech()"
                                id="generateSpeechButton"
                                class="flex-1 bg-neutral-600 dark:bg-neutral-500 text-white py-2 px-4 rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium disabled:bg-neutral-400"
                            >
                                Generate Speech
                            </button>
                            <button
                                onclick="previewVoice()"
                                id="previewButton"
                                class="px-4 py-2 border border-neutral-600 dark:border-neutral-500 text-neutral-600 dark:text-neutral-300 rounded-md hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors font-medium disabled:bg-neutral-100 disabled:text-neutral-400"
                            >
                                Preview Voice
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Generated Audio -->
                <div id="audioResults" class="p-4 border-t border-neutral-200 dark:border-neutral-700 max-h-96 overflow-y-auto overlay-scrollbar">
                    <div class="text-center text-neutral-500 text-sm">
                        Generated audio will appear here
                    </div>
                </div>
            </div>

            <!-- Settings Tab Content -->
            <div id="settingsContent" class="hidden bg-white dark:bg-neutral-800 rounded-b-lg shadow-md transition-colors">
                <div class="p-6 space-y-6">
                    <!-- API Key Management -->
                    <div>
                        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a1 1 0 0 1-1-1v-1a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1a1 1 0 0 1-1 1"/>
                                <path d="M19 15V6.5a1 1 0 0 0-7 0v11a1 1 0 0 1-7 0V9"/>
                                <path d="M21 21v-2h-4"/>
                                <path d="M3 5h4V3"/>
                                <path d="M7 5a1 1 0 0 1 1 1v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1V3"/>
                            </svg>
                            API Management
                        </h3>
                        <div class="space-y-6">
                            <!-- API Key Field -->
                            <div>
                                <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                                    Key
                                </label>
                                <div class="flex space-x-2">
                                    <input
                                        type="password"
                                        id="apiKeyField"
                                        name="password"
                                        placeholder="sk-..."
                                        autocomplete="current-password"
                                        class="flex-1 px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                                    >
                                    <button
                                        onclick="toggleApiKey()"
                                        id="apiKeyToggle"
                                        class="px-4 py-2 bg-neutral-600 dark:bg-neutral-500 text-white rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium"
                                    >
                                        Set
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Base URL Field -->
                            <div>
                                <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                                    Base URL
                                </label>
                                <div class="space-y-2">
                                    <div class="flex space-x-2">
                                        <input
                                            type="url"
                                            id="baseUrlField"
                                            placeholder="https://api.openai.com/v1"
                                            class="flex-1 px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white transition-colors"
                                        >
                                        <button
                                            onclick="toggleBaseUrl()"
                                            id="baseUrlToggle"
                                            class="px-4 py-2 bg-neutral-600 dark:bg-neutral-500 text-white rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium"
                                        >
                                            Set
                                        </button>
                                    </div>
                                    <!-- Preset buttons -->
                                    <div class="flex space-x-2">
                                        <button
                                            onclick="setPresetUrl('openai')"
                                            class="px-3 py-1 text-xs bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded-full hover:bg-neutral-200 dark:hover:bg-neutral-600 transition-colors"
                                        >
                                            openai
                                        </button>
                                        <button
                                            onclick="setPresetUrl('nebius')"
                                            class="px-3 py-1 text-xs bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded-full hover:bg-neutral-200 dark:hover:bg-neutral-600 transition-colors"
                                        >
                                            nebius
                                        </button>
                                        <button
                                            onclick="setPresetUrl('openrouter')"
                                            class="px-3 py-1 text-xs bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded-full hover:bg-neutral-200 dark:hover:bg-neutral-600 transition-colors"
                                        >
                                            openrouter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Settings -->
                    <div>
                        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z"/>
                                <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
                                <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
                                <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
                                <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
                            </svg>
                            Appearance
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                                    Theme
                                </label>
                                <div class="flex space-x-2">
                                    <button
                                        onclick="setTheme('light')"
                                        id="lightThemeBtn"
                                        class="flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md text-sm font-medium bg-white dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-50 dark:hover:bg-neutral-600 transition-colors"
                                    >
                                        Light
                                    </button>
                                    <button
                                        onclick="setTheme('dark')"
                                        id="darkThemeBtn"
                                        class="flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md text-sm font-medium bg-white dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-50 dark:hover:bg-neutral-600 transition-colors"
                                    >
                                        Dark
                                    </button>
                                    <button
                                        onclick="setTheme('auto')"
                                        id="autoThemeBtn"
                                        class="flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md text-sm font-medium bg-neutral-600 dark:bg-neutral-500 text-white hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors"
                                    >
                                        Auto
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- App Info -->
                    <div>
                        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                            About
                        </h3>
                        <div class="text-sm text-neutral-600 dark:text-neutral-300 leading-relaxed">
                            <p>
                                <strong>Vanilla AI</strong> is a lightweight, build-free progressive web app that brings the power of OpenAI's API directly to your browser. 
                                Designed with simplicity in mind, it provides an elegant interface for chat conversations, image generation, and text-to-speech synthesisâ€”all 
                                without the complexity of build tools or frameworks.
                            </p>
                            <p class="mt-3">
                                Whether you're using OpenAI's official API, Nebius, OpenRouter, or any OpenAI-compatible endpoint, Vanilla AI adapts seamlessly 
                                to your preferred provider. Experience the full spectrum of AI capabilities through a clean, responsive interface that works 
                                instantlyâ€”no installation, no configuration, just open and create.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="hidden mt-4 p-4 rounded-md">
            <div class="flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="statusText">Thinking...</span>
            </div>
        </div>
    </div>

    <script type="module">
        // ðŸŽ‰ Native ES6 import from CDN!
        import OpenAI from 'https://cdn.toolbomber.com/libs/openai-sdk/v-latest/openai-sdk.esm.min.js';

        let client = null;
        let messages = [];
        let currentTab = 'chat';
        
        // Dropdown instances
        let chatModelDropdown = null;
        let imageModelDropdown = null;
        let imageSizeDropdown = null;
        let imageQualityDropdown = null;
        let responseFormatDropdown = null;
        let ttsModelDropdown = null;
        let ttsVoiceDropdown = null;
        let ttsSpeedDropdown = null;

        // Unified Dropdown Component
        class UnifiedDropdown {
            constructor(containerId, options = {}) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                this.options = {
                    searchable: options.searchable || false,
                    placeholder: options.placeholder || 'Select an option...',
                    loadingText: options.loadingText || 'Loading...',
                    noOptionsText: options.noOptionsText || 'No options available',
                    onSelect: options.onSelect || (() => {}),
                    onFilter: options.onFilter || null,
                    className: options.className || ''
                };
                
                this.items = [];
                this.selectedValue = '';
                this.selectedText = '';
                this.isOpen = false;
                this.filteredItems = [];
                
                this.create();
                this.bindEvents();
            }
            
            create() {
                const searchableClass = this.options.searchable ? 'searchable' : '';
                this.container.innerHTML = `
                    <div class="unified-dropdown relative ${searchableClass} ${this.options.className}">
                        <div class="dropdown-input-container relative">
                            ${this.options.searchable ? 
                                `<input type="text" class="dropdown-input w-full px-3 py-2 pr-8 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white text-sm transition-colors" 
                                    placeholder="${this.options.placeholder}" autocomplete="off">` :
                                `<button type="button" class="dropdown-button w-full px-3 py-2 pr-8 border border-neutral-300 dark:border-neutral-600 rounded-md focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white text-sm transition-colors text-left">
                                    <span class="dropdown-button-text">${this.options.placeholder}</span>
                                </button>`
                            }
                            <svg class="dropdown-arrow absolute right-2 top-1/2 transform -translate-y-1/2 w-4 h-4 text-neutral-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="dropdown-list hidden absolute z-10 w-full mt-1 bg-white dark:bg-neutral-700 border border-neutral-300 dark:border-neutral-600 rounded-md shadow-lg max-h-48 overflow-y-auto overlay-scrollbar">
                            <div class="dropdown-items py-1">
                                <div class="dropdown-loading px-3 py-2 text-sm text-neutral-500 dark:text-neutral-400">${this.options.loadingText}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.input = this.container.querySelector('.dropdown-input');
                this.button = this.container.querySelector('.dropdown-button');
                this.buttonText = this.container.querySelector('.dropdown-button-text');
                this.list = this.container.querySelector('.dropdown-list');
                this.itemsContainer = this.container.querySelector('.dropdown-items');
                this.arrow = this.container.querySelector('.dropdown-arrow');
            }
            
            bindEvents() {
                // Handle input/button click
                const trigger = this.input || this.button;
                trigger.addEventListener('click', () => this.toggle());
                
                if (this.options.searchable && this.input) {
                    this.input.addEventListener('input', () => this.filter());
                    this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                }
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.close();
                    }
                });
            }
            
            setItems(items) {
                this.items = items;
                this.filteredItems = [...items];
                this.render();
            }
            
            addItem(item) {
                this.items.push(item);
                this.filteredItems = [...this.items];
                this.render();
            }
            
            render() {
                if (this.items.length === 0) {
                    this.itemsContainer.innerHTML = `<div class="px-3 py-2 text-sm text-neutral-500 dark:text-neutral-400">${this.options.noOptionsText}</div>`;
                    return;
                }
                
                this.itemsContainer.innerHTML = '';
                this.filteredItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'dropdown-item px-3 py-2 text-sm cursor-pointer text-neutral-900 dark:text-neutral-100 hover:bg-neutral-100 dark:hover:bg-neutral-600 transition-colors';
                    itemElement.textContent = item.label || item.text || item.id || item;
                    itemElement.setAttribute('data-value', item.value || item.id || item);
                    
                    if (this.selectedValue === (item.value || item.id || item)) {
                        itemElement.classList.add('bg-neutral-100', 'dark:bg-neutral-600');
                    }
                    
                    itemElement.addEventListener('click', () => this.selectItem(item));
                    this.itemsContainer.appendChild(itemElement);
                });
            }
            
            filter() {
                if (!this.options.searchable) return;
                
                const searchTerm = this.input.value.toLowerCase();
                
                if (this.options.onFilter) {
                    this.options.onFilter(searchTerm);
                } else {
                    this.filteredItems = this.items.filter(item => {
                        const text = item.label || item.text || item.id || item;
                        return text.toLowerCase().includes(searchTerm);
                    });
                }
                
                this.render();
            }
            
            selectItem(item) {
                const value = item.value || item.id || item;
                const text = item.label || item.text || item.id || item;
                
                this.selectedValue = value;
                this.selectedText = text;
                
                if (this.options.searchable && this.input) {
                    this.input.value = text;
                } else if (this.buttonText) {
                    this.buttonText.textContent = text;
                }
                
                this.close();
                this.options.onSelect(value, item);
                this.render(); // Re-render to update selection highlighting
            }
            
            setValue(value) {
                const item = this.items.find(item => (item.value || item.id || item) === value);
                if (item) {
                    this.selectItem(item);
                }
            }
            
            getValue() {
                return this.selectedValue;
            }
            
            getText() {
                return this.selectedText;
            }
            
            open() {
                this.isOpen = true;
                this.list.classList.remove('hidden');
                this.arrow.style.transform = 'translateY(-50%) rotate(180deg)';
                
                if (this.options.searchable && this.input) {
                    // Clear search to show all options
                    if (this.input.value === this.selectedText) {
                        this.input.value = '';
                        this.filter();
                    }
                    this.input.focus();
                }
            }
            
            close() {
                this.isOpen = false;
                this.list.classList.add('hidden');
                this.arrow.style.transform = 'translateY(-50%) rotate(0deg)';
                
                if (this.options.searchable && this.input) {
                    // Restore selected value
                    this.input.value = this.selectedText || '';
                }
            }
            
            toggle() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
            
            handleKeydown(event) {
                if (event.key === 'Escape') {
                    this.close();
                } else if (event.key === 'Enter') {
                    event.preventDefault();
                    const firstItem = this.itemsContainer.querySelector('.dropdown-item');
                    if (firstItem) {
                        const value = firstItem.getAttribute('data-value');
                        const item = this.filteredItems.find(item => (item.value || item.id || item) === value);
                        if (item) this.selectItem(item);
                    }
                }
            }
            
            setLoading(loading = true) {
                if (loading) {
                    this.itemsContainer.innerHTML = `<div class="px-3 py-2 text-sm text-neutral-500 dark:text-neutral-400">${this.options.loadingText}</div>`;
                }
            }
        }

        // Theme and localStorage management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('openai-theme') || 'auto';
            window.setTheme(savedTheme, false);
        }

        window.setTheme = function(theme, save = true) {
            if (save) {
                localStorage.setItem('openai-theme', theme);
            }

            const html = document.documentElement;

            if (theme === 'dark') {
                html.classList.add('dark');
            } else if (theme === 'light') {
                html.classList.remove('dark');
            } else { // auto
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            }

            // Update theme button states
            updateThemeButtons(theme);
        }

        function updateThemeButtons(currentTheme) {
            const lightBtn = document.getElementById('lightThemeBtn');
            const darkBtn = document.getElementById('darkThemeBtn');
            const autoBtn = document.getElementById('autoThemeBtn');

            // Reset all buttons to inactive state
            const inactiveClass = 'flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md text-sm font-medium bg-white dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-50 dark:hover:bg-neutral-600 transition-colors';
            const activeClass = 'flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-md text-sm font-medium bg-neutral-600 dark:bg-neutral-500 text-white hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors';

            if (lightBtn) lightBtn.className = currentTheme === 'light' ? activeClass : inactiveClass;
            if (darkBtn) darkBtn.className = currentTheme === 'dark' ? activeClass : inactiveClass;
            if (autoBtn) autoBtn.className = currentTheme === 'auto' ? activeClass : inactiveClass;
        }

        window.toggleDarkMode = function() {
            const currentTheme = localStorage.getItem('openai-theme') || 'auto';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            window.setTheme(newTheme);
        }

        // API Key and Base URL management
        function loadApiKey() {
            const savedKey = localStorage.getItem('openai-api-key');
            if (savedKey) {
                const setupApiKey = document.getElementById('apiKey');
                if (setupApiKey) {
                    setupApiKey.value = savedKey;
                }
                return savedKey;
            }
            return null;
        }

        function loadBaseUrl() {
            const savedUrl = localStorage.getItem('openai-base-url');
            if (savedUrl) {
                document.getElementById('baseUrl').value = savedUrl;
                return savedUrl;
            }
            return null;
        }

        function saveApiKey(apiKey) {
            // Don't save the placeholder key
            if (apiKey !== 'xxxxxxxxxxxxxxxxx') {
                localStorage.setItem('openai-api-key', apiKey);
            }
        }

        function saveBaseUrl(baseUrl) {
            if (baseUrl) {
                localStorage.setItem('openai-base-url', baseUrl);
            } else {
                localStorage.removeItem('openai-base-url');
            }
        }

        function updateApiKeyStatus() {
            // This function is now handled by initializeSettingsFields
            // Keep for compatibility but make it safe
        }

        window.revokeApiKey = function() {
            if (confirm('Are you sure you want to remove the stored API key and base URL?')) {
                localStorage.removeItem('openai-api-key');
                localStorage.removeItem('openai-base-url');
                document.getElementById('apiKey').value = '';
                document.getElementById('baseUrl').value = '';
                const newApiKey = document.getElementById('newApiKey');
                const newBaseUrl = document.getElementById('newBaseUrl');
                if (newApiKey) newApiKey.value = '';
                if (newBaseUrl) newBaseUrl.value = '';
                client = null;

                // Hide app and show setup
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('setup').classList.remove('hidden');
            }
        }

        window.toggleApiKey = function() {
            const field = document.getElementById('apiKeyField');
            const button = document.getElementById('apiKeyToggle');
            const savedKey = localStorage.getItem('openai-api-key');
            
            if (savedKey) {
                // Revoke existing key
                localStorage.removeItem('openai-api-key');
                field.value = '';
                button.textContent = 'Set';
                button.className = button.className.replace('bg-red-600 hover:bg-red-700', 'bg-neutral-600 dark:bg-neutral-500 hover:bg-neutral-700 dark:hover:bg-neutral-600');
                
                // Reinitialize client
                const baseUrl = localStorage.getItem('openai-base-url');
                reinitializeClient('xxxxxxxxxxxxxxxxx', baseUrl);
            } else {
                // Set new key
                const newKey = field.value.trim() || 'xxxxxxxxxxxxxxxxx';
                saveApiKey(newKey);
                const setupApiKey = document.getElementById('apiKey');
                if (setupApiKey) {
                    setupApiKey.value = newKey === 'xxxxxxxxxxxxxxxxx' ? '' : newKey;
                }
                
                button.textContent = 'Revoke';
                button.className = button.className.replace('bg-neutral-600 dark:bg-neutral-500 hover:bg-neutral-700 dark:hover:bg-neutral-600', 'bg-red-600 hover:bg-red-700');
                
                // Reinitialize client with current base URL
                const baseUrl = localStorage.getItem('openai-base-url');
                reinitializeClient(newKey, baseUrl);
            }
        }

        window.toggleBaseUrl = function() {
            const field = document.getElementById('baseUrlField');
            const button = document.getElementById('baseUrlToggle');
            const savedUrl = localStorage.getItem('openai-base-url');
            
            if (savedUrl) {
                // Revoke existing URL
                localStorage.removeItem('openai-base-url');
                field.value = '';
                button.textContent = 'Set';
                button.className = button.className.replace('bg-red-600 hover:bg-red-700', 'bg-neutral-600 dark:bg-neutral-500 hover:bg-neutral-700 dark:hover:bg-neutral-600');
                const setupBaseUrl = document.getElementById('baseUrl');
                if (setupBaseUrl) {
                    setupBaseUrl.value = '';
                }
                
                // Reinitialize client
                const apiKey = localStorage.getItem('openai-api-key') || 'xxxxxxxxxxxxxxxxx';
                reinitializeClient(apiKey, '');
            } else {
                // Set new URL
                const newUrl = field.value.trim();
                saveBaseUrl(newUrl);
                const setupBaseUrl = document.getElementById('baseUrl');
                if (setupBaseUrl) {
                    setupBaseUrl.value = newUrl;
                }
                
                button.textContent = 'Revoke';
                button.className = button.className.replace('bg-neutral-600 dark:bg-neutral-500 hover:bg-neutral-700 dark:hover:bg-neutral-600', 'bg-red-600 hover:bg-red-700');
                
                // Reinitialize client with current API key
                const apiKey = localStorage.getItem('openai-api-key') || 'xxxxxxxxxxxxxxxxx';
                reinitializeClient(apiKey, newUrl);
            }
        }

        window.setPresetUrl = function(provider) {
            const field = document.getElementById('baseUrlField');
            
            const presets = {
                'openai': 'https://api.openai.com/v1',
                'nebius': 'https://api.studio.nebius.ai/v1',
                'openrouter': 'https://openrouter.ai/api/v1'
            };
            
            field.value = presets[provider] || '';
        }

        function initializeSettingsFields() {
            const apiKeyField = document.getElementById('apiKeyField');
            const apiKeyToggle = document.getElementById('apiKeyToggle');
            const baseUrlField = document.getElementById('baseUrlField');
            const baseUrlToggle = document.getElementById('baseUrlToggle');
            
            const savedKey = localStorage.getItem('openai-api-key');
            const savedUrl = localStorage.getItem('openai-base-url');
            
            // Initialize API Key field
            if (savedKey) {
                apiKeyField.placeholder = `${savedKey.slice(0, 8)}...${savedKey.slice(-4)}`;
                apiKeyToggle.textContent = 'Revoke';
                apiKeyToggle.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-medium';
            } else {
                apiKeyField.placeholder = 'sk-...';
                apiKeyToggle.textContent = 'Set';
                apiKeyToggle.className = 'px-4 py-2 bg-neutral-600 dark:bg-neutral-500 text-white rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium';
            }
            
            // Initialize Base URL field
            if (savedUrl) {
                baseUrlField.value = savedUrl;
                baseUrlToggle.textContent = 'Revoke';
                baseUrlToggle.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-medium';
            } else {
                baseUrlField.value = '';
                baseUrlToggle.textContent = 'Set';
                baseUrlToggle.className = 'px-4 py-2 bg-neutral-600 dark:bg-neutral-500 text-white rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors font-medium';
            }
        }

        window.handleModelChange = function() {
            const modelSelect = document.getElementById('chatModel');
            const customModelInput = document.getElementById('customModel');
            
            if (modelSelect.value === 'custom') {
                modelSelect.classList.add('hidden');
                customModelInput.classList.remove('hidden');
                customModelInput.focus();
            } else {
                modelSelect.classList.remove('hidden');
                customModelInput.classList.add('hidden');
            }
        }

        // Initialize dropdown instances
        function initializeDropdowns() {
            // Chat Model Dropdown (searchable)
            chatModelDropdown = new UnifiedDropdown('chatModelDropdown', {
                searchable: true,
                placeholder: 'Select a model...',
                loadingText: 'Loading models...',
                noOptionsText: 'No models found',
                onSelect: (value, item) => {
                    // Update hidden select for compatibility
                    document.getElementById('chatModel').value = value;
                    console.log('Selected model:', value);
                },
                onFilter: null // Use default filtering
            });
            
            // Image Model Dropdown
            imageModelDropdown = new UnifiedDropdown('imageModelDropdown', {
                searchable: false,
                placeholder: 'Select model...',
                onSelect: (value, item) => {
                    document.getElementById('imageModel').value = value;
                    updateImageSizeOptions();
                }
            });
            
            // Image Size Dropdown
            imageSizeDropdown = new UnifiedDropdown('imageSizeDropdown', {
                searchable: false,
                placeholder: 'Select size...',
                onSelect: (value, item) => {
                    document.getElementById('imageSize').value = value;
                }
            });
            
            // Image Quality Dropdown
            imageQualityDropdown = new UnifiedDropdown('imageQualityDropdown', {
                searchable: false,
                placeholder: 'Select quality...',
                onSelect: (value, item) => {
                    document.getElementById('imageQuality').value = value;
                }
            });
            
            // Response Format Dropdown
            responseFormatDropdown = new UnifiedDropdown('responseFormatDropdown', {
                searchable: false,
                placeholder: 'Select format...',
                onSelect: (value, item) => {
                    document.getElementById('responseFormat').value = value;
                }
            });
            
            // TTS Model Dropdown
            ttsModelDropdown = new UnifiedDropdown('ttsModelDropdown', {
                searchable: false,
                placeholder: 'Select model...',
                onSelect: (value, item) => {
                    document.getElementById('ttsModel').value = value;
                }
            });
            
            // TTS Voice Dropdown
            ttsVoiceDropdown = new UnifiedDropdown('ttsVoiceDropdown', {
                searchable: false,
                placeholder: 'Select voice...',
                onSelect: (value, item) => {
                    document.getElementById('ttsVoice').value = value;
                }
            });
            
            // TTS Speed Dropdown
            ttsSpeedDropdown = new UnifiedDropdown('ttsSpeedDropdown', {
                searchable: false,
                placeholder: 'Select speed...',
                onSelect: (value, item) => {
                    document.getElementById('ttsSpeed').value = value;
                }
            });
            
            // Initialize image and TTS dropdowns with default options
            initializeImageDropdowns();
            initializeTTSDropdowns();
        }
        
        function initializeImageDropdowns() {
            // Set initial image model options
            const imageModels = [
                { value: 'gpt-image-1', label: 'GPT-Image-1' },
                { value: 'dall-e-3', label: 'DALL-E 3' },
                { value: 'dall-e-2', label: 'DALL-E 2' }
            ];
            imageModelDropdown.setItems(imageModels);
            imageModelDropdown.setValue('gpt-image-1');
            
            // Trigger initial size options update
            updateImageSizeOptions();
        }
        
        function initializeTTSDropdowns() {
            // Set TTS model options
            const ttsModels = [
                { value: 'tts-1', label: 'TTS-1 (Fast)' },
                { value: 'tts-1-hd', label: 'TTS-1-HD (High Quality)' }
            ];
            ttsModelDropdown.setItems(ttsModels);
            ttsModelDropdown.setValue('tts-1');
            
            // Set TTS voice options
            const ttsVoices = [
                { value: 'alloy', label: 'Alloy' },
                { value: 'echo', label: 'Echo' },
                { value: 'fable', label: 'Fable' },
                { value: 'onyx', label: 'Onyx' },
                { value: 'nova', label: 'Nova' },
                { value: 'shimmer', label: 'Shimmer' }
            ];
            ttsVoiceDropdown.setItems(ttsVoices);
            ttsVoiceDropdown.setValue('alloy');
            
            // Set TTS speed options
            const ttsSpeeds = [
                { value: '0.25', label: '0.25x' },
                { value: '0.5', label: '0.5x' },
                { value: '0.75', label: '0.75x' },
                { value: '1.0', label: '1.0x (Normal)' },
                { value: '1.25', label: '1.25x' },
                { value: '1.5', label: '1.5x' },
                { value: '2.0', label: '2.0x' },
                { value: '4.0', label: '4.0x' }
            ];
            ttsSpeedDropdown.setItems(ttsSpeeds);
            ttsSpeedDropdown.setValue('1.0');
        }

        async function loadAvailableModels() {
            if (!client || !chatModelDropdown) return;
            
            chatModelDropdown.setLoading(true);
            
            try {
                console.log('ðŸ” Fetching available models...');
                const models = await client.models.list();
                console.log('âœ… Models fetched:', models.data.length);
                
                // Filter and sort models (prioritize chat/instruct models)
                const sortedModels = models.data
                    .filter(model => {
                        const id = model.id.toLowerCase();
                        // Prioritize chat, instruct, and gpt models
                        return id.includes('chat') || id.includes('instruct') || id.includes('gpt') || 
                               id.includes('llama') || id.includes('deepseek') || true; // fallback to show all
                    })
                    .sort((a, b) => {
                        // Prioritize certain models
                        const priority = (id) => {
                            if (id.includes('gpt-4')) return 1;
                            if (id.includes('gpt-3.5')) return 2;
                            if (id.includes('deepseek')) return 3;
                            if (id.includes('llama')) return 4;
                            return 5;
                        };
                        return priority(a.id) - priority(b.id) || a.id.localeCompare(b.id);
                    })
                    .map(model => ({ id: model.id, label: model.id })); // Convert to dropdown format
                
                // Set models in dropdown
                chatModelDropdown.setItems(sortedModels);
                
                // Select first model by default
                if (sortedModels.length > 0) {
                    chatModelDropdown.setValue(sortedModels[0].id);
                    console.log('ðŸŽ¯ Default model selected:', sortedModels[0].id);
                }
                
            } catch (error) {
                console.error('âŒ Failed to fetch models:', error);
                
                // Provide helpful fallback based on the base URL
                const isNebius = client.baseURL?.includes('nebius');
                const isLocal = client.baseURL?.includes('localhost') || client.baseURL?.includes('127.0.0.1');
                
                let fallbackModels = [];
                
                if (isNebius) {
                    fallbackModels = [
                        { id: 'deepseek-ai/DeepSeek-R1', label: 'deepseek-ai/DeepSeek-R1' },
                        { id: 'deepseek-ai/DeepSeek-V3', label: 'deepseek-ai/DeepSeek-V3' },
                        { id: 'meta-llama/Meta-Llama-3.1-70B-Instruct', label: 'meta-llama/Meta-Llama-3.1-70B-Instruct' }
                    ];
                } else if (isLocal) {
                    fallbackModels = [
                        { id: 'llama3.2', label: 'llama3.2' },
                        { id: 'mistral', label: 'mistral' }
                    ];
                } else {
                    fallbackModels = [
                        { id: 'gpt-4o-mini', label: 'gpt-4o-mini' },
                        { id: 'gpt-3.5-turbo', label: 'gpt-3.5-turbo' }
                    ];
                }
                
                chatModelDropdown.setItems(fallbackModels);
                
                if (fallbackModels.length > 0) {
                    chatModelDropdown.setValue(fallbackModels[0].id);
                }
                
                console.warn('âš ï¸ Could not load models from API. Using provider-specific fallback options.');
            }
        }

        function reinitializeClient(apiKey, baseUrl) {
            try {
                const config = {
                    apiKey,
                    dangerouslyAllowBrowser: true
                };

                if (baseUrl) {
                    // Ensure baseURL doesn't end with slash to avoid double slashes
                    config.baseURL = baseUrl.replace(/\/$/, '');
                    console.log('ðŸ”§ Client config:', { apiKey: apiKey.slice(0, 8) + '...', baseURL: config.baseURL });
                } else {
                    console.log('ðŸ”§ Client config: Using default OpenAI API');
                }

                client = new OpenAI(config);
                
                // Update tab availability based on provider
                updateTabAvailability(baseUrl);
                
                // Load models after client is initialized
                loadAvailableModels();
            } catch (error) {
                alert('Error initializing client: ' + error.message);
            }
        }

        window.initializeApp = async function() {
            const apiKey = document.getElementById('apiKey').value.trim() || 'xxxxxxxxxxxxxxxxx';
            const baseUrl = document.getElementById('baseUrl').value.trim();

            try {
                const config = {
                    apiKey,
                    dangerouslyAllowBrowser: true
                };

                if (baseUrl) {
                    // Ensure baseURL doesn't end with slash to avoid double slashes
                    config.baseURL = baseUrl.replace(/\/$/, '');
                    console.log('ðŸš€ Initializing with baseURL:', config.baseURL);
                } else {
                    console.log('ðŸš€ Initializing with default OpenAI API');
                }

                client = new OpenAI(config);
                console.log('âœ… Client initialized successfully');

                // Update tab availability based on provider
                updateTabAvailability(baseUrl);

                // Load available models
                await loadAvailableModels();

                // Save API key and base URL to localStorage
                saveApiKey(apiKey);
                saveBaseUrl(baseUrl);

                // Hide setup, show app
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');

                // Focus on message input by default
                document.getElementById('messageInput').focus();

            } catch (error) {
                alert('Error initializing OpenAI client: ' + error.message);
            }
        }

        function updateTabAvailability(baseUrl) {
            const isOpenAI = !baseUrl || baseUrl.includes('api.openai.com');
            const imageTab = document.getElementById('imageTab');
            const ttsTab = document.getElementById('ttsTab');
            
            console.log('ðŸ”§ Updating tab availability:', { baseUrl, isOpenAI });
            
            if (isOpenAI) {
                // Enable image and TTS tabs for OpenAI
                imageTab.style.opacity = '1';
                imageTab.style.pointerEvents = 'auto';
                imageTab.title = 'Image Generation';
                
                ttsTab.style.opacity = '1';
                ttsTab.style.pointerEvents = 'auto';
                ttsTab.title = 'Text-to-Speech';
                
                console.log('âœ… Image and TTS tabs enabled for OpenAI API');
            } else {
                // Disable image and TTS tabs for other providers
                imageTab.style.opacity = '0.5';
                imageTab.style.pointerEvents = 'none';
                imageTab.title = 'Image Generation (OpenAI API only)';
                
                ttsTab.style.opacity = '0.5';
                ttsTab.style.pointerEvents = 'none';
                ttsTab.title = 'Text-to-Speech (OpenAI API only)';
                
                // If currently on disabled tab, switch to chat
                const currentTab = document.querySelector('[class*="bg-neutral-600"]').id;
                if (currentTab === 'imageTab' || currentTab === 'ttsTab') {
                    window.switchTab('chat');
                }
                
                console.log('âš ï¸ Image and TTS tabs disabled for non-OpenAI provider');
            }
        }

        window.switchTab = function(tab) {
            // Check if trying to access disabled tab
            const baseUrl = localStorage.getItem('openai-base-url');
            const isOpenAI = !baseUrl || baseUrl.includes('api.openai.com');
            
            if (!isOpenAI && (tab === 'image' || tab === 'tts')) {
                console.log('âš ï¸ Cannot access disabled tab:', tab);
                return; // Prevent switching to disabled tabs
            }

            currentTab = tab;

            // Update tab buttons
            const chatTab = document.getElementById('chatTab');
            const imageTab = document.getElementById('imageTab');
            const ttsTab = document.getElementById('ttsTab');
            const settingsTab = document.getElementById('settingsTab');
            const chatContent = document.getElementById('chatContent');
            const imageContent = document.getElementById('imageContent');
            const ttsContent = document.getElementById('ttsContent');
            const settingsContent = document.getElementById('settingsContent');

            // Reset all tabs to inactive state
            const inactiveClass = 'flex-1 px-3 py-3 text-center font-medium text-lg text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 bg-neutral-50 dark:bg-neutral-700 transition-colors';

            chatTab.className = inactiveClass + ' rounded-tl-lg';
            imageTab.className = inactiveClass;
            ttsTab.className = inactiveClass;
            settingsTab.className = inactiveClass + ' rounded-tr-lg';

            // Hide all content
            chatContent.classList.add('hidden');
            imageContent.classList.add('hidden');
            ttsContent.classList.add('hidden');
            settingsContent.classList.add('hidden');

            if (tab === 'chat') {
                chatTab.className = 'flex-1 px-3 py-3 text-center font-medium text-lg bg-neutral-600 dark:bg-neutral-500 text-white rounded-tl-lg transition-colors';
                chatContent.classList.remove('hidden');
                setTimeout(() => document.getElementById('messageInput')?.focus(), 100);
            } else if (tab === 'image') {
                imageTab.className = 'flex-1 px-3 py-3 text-center font-medium text-lg bg-neutral-600 dark:bg-neutral-500 text-white transition-colors';
                imageContent.classList.remove('hidden');
                setTimeout(() => document.getElementById('imagePrompt')?.focus(), 100);
            } else if (tab === 'tts') {
                ttsTab.className = 'flex-1 px-3 py-3 text-center font-medium text-lg bg-neutral-600 dark:bg-neutral-500 text-white transition-colors';
                ttsContent.classList.remove('hidden');
                setTimeout(() => document.getElementById('ttsText')?.focus(), 100);
            } else if (tab === 'settings') {
                settingsTab.className = 'flex-1 px-3 py-3 text-center font-medium text-lg bg-neutral-600 dark:bg-neutral-500 text-white rounded-tr-lg transition-colors';
                settingsContent.classList.remove('hidden');
                initializeSettingsFields();
                updateThemeButtons(localStorage.getItem('openai-theme') || 'auto');
            }
        }

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || !client) return;

            // Add user message
            addMessage('user', message);
            messageInput.value = '';

            // Show loading status
            showStatus('Thinking...');

            try {
                // Add user message to conversation
                messages.push({ role: 'user', content: message });

                // Get model from unified dropdown
                const model = chatModelDropdown?.getValue();
                
                if (!model) {
                    alert('Please select a model');
                    return;
                }
                
                console.log('ðŸ”¥ Making API call:', { model, baseURL: client.baseURL, messages: messages.length + ' messages' });
                
                const completion = await client.chat.completions.create({
                    model: model,
                    messages: messages,
                    max_tokens: 1000,
                });
                
                console.log('âœ… API call successful');

                const assistantMessage = completion.choices[0].message.content;

                // Add assistant message
                addMessage('assistant', assistantMessage);
                messages.push({ role: 'assistant', content: assistantMessage });

            } catch (error) {
                addMessage('error', 'Error: ' + error.message);
                console.error('API Error:', error);
            } finally {
                hideStatus();
            }
        }

        function addMessage(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');

            if (role === 'user') {
                messageDiv.className = 'mb-4 flex justify-end px-4';
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white px-4 py-2 rounded-lg max-w-xs lg:max-w-md">
                        ${escapeHtml(content)}
                    </div>
                `;
            } else if (role === 'assistant') {
                messageDiv.className = 'mb-4 flex justify-start px-4';
                messageDiv.innerHTML = `
                    <div class="bg-neutral-200 text-neutral-900 px-4 py-2 rounded-lg max-w-xs lg:max-w-md">
                        ${formatAssistantMessage(content)}
                    </div>
                `;
            } else if (role === 'error') {
                messageDiv.className = 'mb-4 flex justify-center px-4';
                messageDiv.innerHTML = `
                    <div class="bg-red-100 text-red-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md border border-red-300">
                        ${escapeHtml(content)}
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatAssistantMessage(content) {
            // Simple markdown-like formatting
            return escapeHtml(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code class="bg-neutral-300 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(text) {
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusText.textContent = text;
            status.className = 'mt-4 p-4 rounded-md bg-blue-50 border border-blue-200';
            status.classList.remove('hidden');

            // Disable send button
            document.getElementById('sendButton').disabled = true;
        }

        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        }

        window.clearChat = function() {
            if (confirm('Are you sure you want to clear the chat?')) {
                messages = [];
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="p-4">
                        <div class="text-center text-neutral-500 text-sm">
                            Chat cleared. Start a new conversation!
                        </div>
                    </div>
                `;
            }
        }

        window.generateImage = async function() {
            const prompt = document.getElementById('imagePrompt').value.trim();

            if (!prompt || !client) {
                alert('Please enter a prompt for image generation');
                return;
            }

            const model = imageModelDropdown?.getValue() || 'dall-e-3';
            const size = imageSizeDropdown?.getValue() || '1024x1024';
            const quality = imageQualityDropdown?.getValue() || 'standard';
            const responseFormat = responseFormatDropdown?.getValue() || 'url';

            // Show loading status
            showStatus('Generating image...');
            document.getElementById('generateButton').disabled = true;

            try {
                const requestParams = {
                    model: model,
                    prompt: prompt,
                    size: size,
                    quality: quality,
                    n: 1,
                };

                // Only add response_format for models that support it (not gpt-image-1)
                if (model !== 'gpt-image-1') {
                    requestParams.response_format = responseFormat;
                }

                const response = await client.images.generate(requestParams);

                let imageUrl;
                const imageData = response.data[0];

                if (responseFormat === 'b64_json' || model === 'gpt-image-1') {
                    // Convert base64 to blob URL
                    const base64Data = imageData.b64_json;
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/png' });
                    imageUrl = URL.createObjectURL(blob);
                } else {
                    // Use URL directly
                    imageUrl = imageData.url;
                }

                addImageResult(prompt, imageUrl, imageData.revised_prompt, responseFormat === 'b64_json' || model === 'gpt-image-1');

                // Clear the prompt
                document.getElementById('imagePrompt').value = '';

            } catch (error) {
                addImageError('Error generating image: ' + error.message);
                console.error('Image Generation Error:', error);
            } finally {
                hideStatus();
                document.getElementById('generateButton').disabled = false;
            }
        }

        function addImageResult(originalPrompt, imageUrl, revisedPrompt, isBase64 = false) {
            const imageResults = document.getElementById('imageResults');

            // Clear placeholder text if this is the first image
            if (imageResults.children.length === 1 && imageResults.children[0].textContent.includes('Generated images will appear here')) {
                imageResults.innerHTML = '';
            }

            const resultDiv = document.createElement('div');
            resultDiv.className = 'mb-6 p-4 border border-neutral-200 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-700 transition-colors';

            const timestamp = new Date().toLocaleString();
            const formatInfo = isBase64 ? 'Base64 (Permanent)' : 'URL (60min expiry)';

            resultDiv.innerHTML = `
                <div class="mb-3">
                    <h4 class="font-medium text-neutral-900 dark:text-white mb-2">Generated Image</h4>
                    <p class="text-sm text-neutral-600 dark:text-neutral-300 mb-1"><strong>Your prompt:</strong> ${escapeHtml(originalPrompt)}</p>
                    ${revisedPrompt && revisedPrompt !== originalPrompt ?
                        `<p class="text-sm text-neutral-600 dark:text-neutral-300 mb-1"><strong>Revised prompt:</strong> ${escapeHtml(revisedPrompt)}</p>` : ''
                    }
                    <p class="text-sm text-neutral-500 dark:text-neutral-400"><strong>Format:</strong> ${formatInfo} â€¢ ${timestamp}</p>
                </div>
                <div class="flex justify-center bg-neutral-50 dark:bg-neutral-600 rounded-lg p-2">
                    <img src="${imageUrl}" alt="Generated image" class="max-w-full h-auto rounded-lg shadow-md" style="max-height: 400px;">
                </div>
                <div class="mt-3 flex justify-center space-x-2">
                    <a href="${imageUrl}" download="generated-image-${Date.now()}.png" class="px-3 py-1 bg-blue-600 dark:bg-blue-500 text-white text-sm rounded hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                        Download
                    </a>
                    <button onclick="removeImageResult(this, '${imageUrl}', ${isBase64})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
                        Delete
                    </button>
                </div>
            `;

            imageResults.appendChild(resultDiv);
            imageResults.scrollTop = imageResults.scrollHeight;
        }

        window.removeImageResult = function(button, imageUrl, isBase64) {
            // Clean up blob URL if it was created from base64
            if (isBase64 && imageUrl.startsWith('blob:')) {
                URL.revokeObjectURL(imageUrl);
            }
            button.closest('.mb-6').remove();
        }

        function addImageError(errorMessage) {
            const imageResults = document.getElementById('imageResults');

            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-4 p-3 bg-red-100 border border-red-300 rounded-lg';
            errorDiv.innerHTML = `
                <div class="text-red-800 text-sm">${escapeHtml(errorMessage)}</div>
                <button onclick="this.parentElement.remove()" class="mt-2 text-xs text-red-600 hover:text-red-800">
                    Dismiss
                </button>
            `;

            imageResults.appendChild(errorDiv);
        }

        // Initialize
        document.getElementById('messageInput').addEventListener('input', function() {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !this.value.trim() || !client;
        });

        document.getElementById('imagePrompt').addEventListener('input', function() {
            const generateButton = document.getElementById('generateButton');
            generateButton.disabled = !this.value.trim() || !client;
        });

        window.generateSpeech = async function() {
            const text = document.getElementById('ttsText').value.trim();

            if (!text || !client) {
                alert('Please enter text to convert to speech');
                return;
            }

            const model = ttsModelDropdown?.getValue() || 'tts-1';
            const voice = ttsVoiceDropdown?.getValue() || 'alloy';
            const speed = parseFloat(ttsSpeedDropdown?.getValue() || '1.0');

            // Show loading status
            showStatus('Generating speech...');
            document.getElementById('generateSpeechButton').disabled = true;

            try {
                const response = await client.audio.speech.create({
                    model: model,
                    voice: voice,
                    input: text,
                    speed: speed,
                });

                // Convert response to blob and create audio URL
                const audioBlob = new Blob([await response.arrayBuffer()], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);

                addAudioResult(text, audioUrl, model, voice, speed);

                // Clear the text
                document.getElementById('ttsText').value = '';
                updateCharCount();

            } catch (error) {
                addAudioError('Error generating speech: ' + error.message);
                console.error('TTS Error:', error);
            } finally {
                hideStatus();
                document.getElementById('generateSpeechButton').disabled = false;
            }
        }

        window.previewVoice = async function() {
            const voice = ttsVoiceDropdown?.getValue() || 'alloy';
            const speed = parseFloat(ttsSpeedDropdown?.getValue() || '1.0');

            // Sample text for voice preview
            const previewTexts = {
                'alloy': 'Hi, I\'m Alloy. I have a balanced and friendly voice.',
                'echo': 'Hello, I\'m Echo. My voice is clear and articulate.',
                'fable': 'Hey there, I\'m Fable. I sound warm and expressive.',
                'onyx': 'Greetings, I\'m Onyx. My voice is deep and resonant.',
                'nova': 'Hi, I\'m Nova. I have a bright and energetic voice.',
                'shimmer': 'Hello, I\'m Shimmer. My voice is soft and gentle.'
            };

            const previewText = previewTexts[voice] || 'This is a preview of the selected voice.';

            if (!client) {
                alert('Please initialize the app first');
                return;
            }

            // Show loading status
            showStatus('Generating voice preview...');
            document.getElementById('previewButton').disabled = true;

            try {
                const response = await client.audio.speech.create({
                    model: 'tts-1', // Use faster model for preview
                    voice: voice,
                    input: previewText,
                    speed: speed,
                });

                // Convert response to blob and play immediately
                const audioBlob = new Blob([await response.arrayBuffer()], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);

                const audio = new Audio(audioUrl);
                audio.play();

                // Clean up the URL after playing
                audio.addEventListener('ended', () => {
                    URL.revokeObjectURL(audioUrl);
                });

            } catch (error) {
                addAudioError('Error generating voice preview: ' + error.message);
                console.error('Voice Preview Error:', error);
            } finally {
                hideStatus();
                document.getElementById('previewButton').disabled = false;
            }
        }

        function addAudioResult(text, audioUrl, model, voice, speed) {
            const audioResults = document.getElementById('audioResults');

            // Clear placeholder text if this is the first audio
            if (audioResults.children.length === 1 && audioResults.children[0].textContent.includes('Generated audio will appear here')) {
                audioResults.innerHTML = '';
            }

            const resultDiv = document.createElement('div');
            resultDiv.className = 'mb-6 p-6 border border-neutral-200 dark:border-neutral-600 rounded-xl bg-white dark:bg-neutral-800 shadow-sm hover:shadow-md transition-all duration-200';

            const timestamp = new Date().toLocaleString();

            resultDiv.innerHTML = `
                <!-- Header with clean title and timestamp -->
                <div class="flex items-start justify-between mb-4">
                    <h4 class="text-lg font-semibold text-neutral-900 dark:text-white">Audio Generated</h4>
                    <time class="text-xs text-neutral-500 dark:text-neutral-400 font-mono bg-neutral-100 dark:bg-neutral-600 px-2 py-1 rounded-md">
                        ${timestamp}
                    </time>
                </div>

                <!-- Text content with elegant presentation -->
                <div class="mb-4">
                    <div class="text-neutral-700 dark:text-neutral-200 leading-relaxed border-l-2 border-neutral-300 dark:border-neutral-600 pl-4 py-2 bg-neutral-50/50 dark:bg-neutral-700/50 rounded-r-md">
                        <span class="font-medium">"</span>${escapeHtml(text.substring(0, 120))}${text.length > 120 ? 'â€¦' : ''}<span class="font-medium">"</span>
                    </div>
                </div>

                <!-- Technical specs with minimal design -->
                <div class="flex flex-wrap gap-2 mb-4 text-xs">
                    <span class="px-2 py-1 bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-400 rounded-md font-medium">
                        ${model.toUpperCase()}
                    </span>
                    <span class="px-2 py-1 bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-400 rounded-md">
                        ${voice.charAt(0).toUpperCase() + voice.slice(1)} voice
                    </span>
                    <span class="px-2 py-1 bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-400 rounded-md">
                        ${speed}Ã— speed
                    </span>
                </div>

                <!-- Audio player with clean styling -->
                <div class="bg-neutral-50 dark:bg-neutral-700 rounded-lg p-3 mb-4 border border-neutral-200 dark:border-neutral-600">
                    <audio controls class="w-full">
                        <source src="${audioUrl}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </div>

                <!-- Action buttons with neutral styling -->
                <div class="flex justify-end space-x-3">
                    <button onclick="this.parentElement.parentElement.remove(); URL.revokeObjectURL('${audioUrl}')" class="inline-flex items-center space-x-2 px-3 py-2 text-sm text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        <span>Remove</span>
                    </button>
                    <a href="${audioUrl}" download="speech-${Date.now()}.mp3" class="inline-flex items-center space-x-2 px-4 py-2 bg-neutral-600 dark:bg-neutral-500 text-white text-sm font-medium rounded-md hover:bg-neutral-700 dark:hover:bg-neutral-600 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>Download MP3</span>
                    </a>
                </div>
            `;

            audioResults.appendChild(resultDiv);
            audioResults.scrollTop = audioResults.scrollHeight;
        }

        function addAudioError(errorMessage) {
            const audioResults = document.getElementById('audioResults');

            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-4 p-3 bg-red-100 dark:bg-red-900 border border-red-300 dark:border-red-700 rounded-lg';
            errorDiv.innerHTML = `
                <div class="text-red-800 dark:text-red-200 text-sm">${escapeHtml(errorMessage)}</div>
                <button onclick="this.parentElement.remove()" class="mt-2 text-xs text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200 transition-colors">
                    Dismiss
                </button>
            `;

            audioResults.appendChild(errorDiv);
        }

        function updateCharCount() {
            const text = document.getElementById('ttsText').value;
            document.getElementById('charCount').textContent = text.length;
        }

        // Add character counter for TTS
        document.getElementById('ttsText').addEventListener('input', function() {
            updateCharCount();
            const generateButton = document.getElementById('generateSpeechButton');
            const previewButton = document.getElementById('previewButton');
            const hasText = this.value.trim().length > 0;
            generateButton.disabled = !hasText || !client;
            previewButton.disabled = !client;
        });

        function updateImageSizeOptions() {
            // Don't proceed if dropdowns aren't initialized yet
            if (!imageModelDropdown || !imageSizeDropdown || !imageQualityDropdown || !responseFormatDropdown) {
                return;
            }
            
            const model = imageModelDropdown.getValue() || 'dall-e-3';

            // Define size options for each model
            const sizeOptions = {
                'gpt-image-1': [
                    { value: 'auto', label: 'Auto (Default)' },
                    { value: '1024x1024', label: '1024Ã—1024 (Square)' },
                    { value: '1536x1024', label: '1536Ã—1024 (Landscape)' },
                    { value: '1024x1536', label: '1024Ã—1536 (Portrait)' }
                ],
                'dall-e-3': [
                    { value: '1024x1024', label: '1024Ã—1024 (Square)' },
                    { value: '1792x1024', label: '1792Ã—1024 (Landscape)' },
                    { value: '1024x1792', label: '1024Ã—1792 (Portrait)' }
                ],
                'dall-e-2': [
                    { value: '256x256', label: '256Ã—256' },
                    { value: '512x512', label: '512Ã—512' },
                    { value: '1024x1024', label: '1024Ã—1024' }
                ]
            };

            // Define quality options for each model
            const qualityOptions = {
                'gpt-image-1': [
                    { value: 'auto', label: 'Auto (Default)' },
                    { value: 'high', label: 'High' },
                    { value: 'medium', label: 'Medium' },
                    { value: 'low', label: 'Low' }
                ],
                'dall-e-3': [
                    { value: 'standard', label: 'Standard' },
                    { value: 'hd', label: 'HD' }
                ],
                'dall-e-2': [
                    { value: 'standard', label: 'Standard (Only Option)' }
                ]
            };

            // Define response format options for each model
            const responseFormatOptions = {
                'gpt-image-1': [
                    { value: 'b64_json', label: 'Base64 JSON (Always for GPT-Image-1)' }
                ],
                'dall-e-3': [
                    { value: 'url', label: 'URL (60min expiry)' },
                    { value: 'b64_json', label: 'Base64 JSON' }
                ],
                'dall-e-2': [
                    { value: 'url', label: 'URL (60min expiry)' },
                    { value: 'b64_json', label: 'Base64 JSON' }
                ]
            };

            // Update dropdowns
            const sizes = sizeOptions[model] || sizeOptions['dall-e-3'];
            imageSizeDropdown.setItems(sizes);
            imageSizeDropdown.setValue(sizes[0].value);

            const qualities = qualityOptions[model] || [];
            imageQualityDropdown.setItems(qualities);
            if (qualities.length > 0) {
                imageQualityDropdown.setValue(qualities[0].value);
            }

            const responseFormats = responseFormatOptions[model] || responseFormatOptions['dall-e-3'];
            responseFormatDropdown.setItems(responseFormats);
            responseFormatDropdown.setValue(responseFormats[0].value);

            // Handle special cases for GPT-Image-1
            if (model === 'gpt-image-1') {
                // Disable response format dropdown since it's always b64_json
                responseFormatDropdown.container.style.opacity = '0.5';
                responseFormatDropdown.container.style.pointerEvents = 'none';
                responseFormatDropdown.container.title = 'GPT-Image-1 always returns Base64 format';
            } else {
                responseFormatDropdown.container.style.opacity = '1';
                responseFormatDropdown.container.style.pointerEvents = 'auto';
                responseFormatDropdown.container.title = '';
            }
        }

        // Initialize image size options on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            initializeDropdowns();
            // updateImageSizeOptions() is now called from initializeImageDropdowns()

            // Load saved API key and base URL if available
            const savedKey = loadApiKey();
            const savedUrl = loadBaseUrl();

            if (savedKey || savedUrl) {
                // Auto-initialize if we have a saved key or base URL
                try {
                    const config = {
                        apiKey: savedKey || 'xxxxxxxxxxxxxxxxx',
                        dangerouslyAllowBrowser: true
                    };

                    if (savedUrl) {
                        config.baseURL = savedUrl.replace(/\/$/, '');
                    }

                    client = new OpenAI(config);

                    // Update tab availability based on saved URL
                    updateTabAvailability(savedUrl);

                    // Load models after client is initialized
                    loadAvailableModels();

                    // Hide setup, show app
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                } catch (error) {
                    console.error('Error auto-initializing with saved configuration:', error);
                }
            }

            // Settings are initialized when switching to settings tab
        });
    </script>
</body>
</html>
